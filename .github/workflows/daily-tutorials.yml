name: ðŸ¤– Daily Tutorial Generator

on:
  # Run every day at 9:00 AM UTC (11:00 AM Israel Time)
  schedule:
    - cron: '0 9 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      num_tutorials:
        description: 'Number of tutorials to generate'
        required: false
        default: '3'

jobs:
  generate-tutorials:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ðŸ”¥ Discover trending topics
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          cd $GITHUB_WORKSPACE
          echo "ðŸ” Discovering trending topics from Hacker News, GitHub, Reddit..."
          python scripts/discover_trending_topics.py

      - name: ðŸ¤– Generate tutorials
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          NUM_TUTORIALS: ${{ github.event.inputs.num_tutorials || '3' }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd $GITHUB_WORKSPACE
          echo "ðŸ“ Generating tutorials on trending topics..."
          echo "ðŸ” Using duplicate checking and sentiment analysis..."
          python scripts/generate_tutorial.py

      - name: ðŸ“Š Check if new files created
        id: check_files
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… New tutorials created!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new files created"
          fi

      - name: ðŸ“ Commit and push changes
        if: steps.check_files.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add new posts
          git add _posts/*.md

          # Create commit message with date
          COMMIT_MSG="ðŸ¤– Auto-generated tutorials - $(date '+%Y-%m-%d %H:%M:%S')

          Generated $NUM_TUTORIALS new comprehensive tutorials on trending tech topics.

          ðŸŽ¨ Featured images created with XAI Image API
          ðŸ“ Content generated with Grok-2
          ðŸš€ Automated with GitHub Actions"

          git commit -m "$COMMIT_MSG"

          # Push changes
          git push

      - name: ðŸ“¢ Summary
        if: always()
        run: |
          echo "## ðŸ¤– Daily Tutorial Generator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **Tutorials Generated**: $NUM_TUTORIALS" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f _posts/*.md ]]; then
            echo "### ðŸ“ New Posts:" >> $GITHUB_STEP_SUMMARY
            for file in _posts/*-$(date '+%Y-%m-%d')*.md; do
              if [[ -f "$file" ]]; then
                title=$(grep "^title:" "$file" | head -1 | sed 's/title: "\(.*\)"/\1/')
                echo "- $title" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
